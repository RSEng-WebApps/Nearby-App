<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nearby Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    body { font-family: Arial; margin: 0; padding: 0; }
    h2 { text-align: center; padding: 0.5em; }
    #search { margin: 0 auto; display: block; width: 80%; padding: 0.5em; margin-bottom: 1em; font-size: 1em; }
    #map { height: 60vh; }
    #list { padding: 1em; overflow-y: auto; max-height: 40vh; }
    .location { margin-bottom: 1em; border-bottom: 1px solid #ccc; padding-bottom: 0.5em; cursor: pointer; }
    .location:hover { background-color: #f0f0f0; }
    .leaflet-tooltip { font-size: 10px; }
  </style>
</head>
<body>

<h2>Nearby Projects</h2>
<input type="text" id="search" placeholder="Search projects by number, name, or address...">
<div id="map"></div>
<div id="list">Loading...</div>

<script src="leaflet.js"></script>
<script>
  async function loadProjectsCSV() {
    const res = await fetch("projectrefined.csv");
    const text = await res.text();
    const rows = text.trim().split('\n').slice(1);

    return rows.map(row => {
      const parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      if (parts.length < 6) return null;

      const projectNumber = parts[0].trim();
      const name = parts[1].trim();
      const address = parts[2].trim();
      const lat = parseFloat(parts[3]);
      const lon = parseFloat(parts[4]);
      const legal = parts[5] || '';
      const manager = parts[6] || '';
      const status = parts[7] || '';

      if (!lat || !lon || lat === 0 || lon === 0) return null;

      return { projectNumber, name, address, lat, lon, legal, manager, status };
    }).filter(p => p !== null);
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const toRad = x => x * Math.PI / 180;
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function initApp(userLat, userLon) {
    const map = L.map('map').setView([userLat, userLon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    L.marker([userLat, userLon], {
      icon: L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-red.png',
        iconSize: [24, 36],
        iconAnchor: [12, 36]
      })
    }).addTo(map).bindPopup("You are here").openPopup();

    const projects = await loadProjectsCSV();
    const sorted = projects.map(p => ({
      ...p,
      distance: haversine(userLat, userLon, p.lat, p.lon)
    })).sort((a, b) => a.distance - b.distance);

    const list = document.getElementById("list");
    const searchInput = document.getElementById("search");
    list.innerHTML = "";

    sorted.forEach(p => {
      const popupHtml = `
        <strong>${p.projectNumber}</strong> ${p.name}<br>
        ${p.address}<br>
        ${p.legal}<br>
        Project Manager: ${p.manager}<br>
        Status: ${p.status}<br>
        <a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">Get Directions</a>
      `;

      const marker = L.marker([p.lat, p.lon]).addTo(map).bindPopup(popupHtml);

      const tooltip = L.tooltip({
        permanent: true,
        direction: 'top',
        offset: [0, -20],
        className: 'leaflet-tooltip'
      }).setContent(p.projectNumber).setLatLng([p.lat, p.lon]).addTo(map);

      const div = document.createElement("div");
      div.className = "location";
      div.innerHTML = `
        <strong>${p.projectNumber}</strong> ${p.name}<br>
        ${p.address}<br>
        ${p.legal}<br>
        ${p.distance.toFixed(2)} km
      `;
      div.onclick = () => {
        map.setView([p.lat, p.lon], 17);
        marker.openPopup();
      };
      list.appendChild(div);
    });

    searchInput.addEventListener("input", function () {
      const term = this.value.toLowerCase();
      list.innerHTML = "";
      sorted.forEach(p => {
        const match =
          p.projectNumber.toLowerCase().includes(term) ||
          p.name.toLowerCase().includes(term) ||
          p.address.toLowerCase().includes(term);

        if (match || term === "") {
          const div = document.createElement("div");
          div.className = "location";
          div.innerHTML = `
            <strong>${p.projectNumber}</strong> ${p.name}<br>
            ${p.address}<br>
            ${p.legal}<br>
            ${p.distance.toFixed(2)} km
          `;
          div.onclick = () => {
            map.setView([p.lat, p.lon], 17);
          };
          list.appendChild(div);
        }
      });
    });
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => initApp(pos.coords.latitude, pos.coords.longitude),
      err => {
        document.getElementById("list").innerText = "Location error: " + err.message;
      }
    );
  } else {
    document.getElementById("list").innerText = "Geolocation not supported.";
  }
</script>

</body>
</html>
