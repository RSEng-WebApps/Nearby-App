<style>
    /* ... previous styles ... */
    .leaflet-label div {
        background-color: white;
        padding: 2px 4px;
        border-radius: 3px; /* Optional: for rounded corners */
    }
</style>

<script>
    let allMarkers = [];
    let allProjects = [];
    let map; // Declare map variable outside initApp for broader scope
    let projectListDiv = document.getElementById("list"); // Get list element once
    let searchInput = document.getElementById("search"); // Get search input once
    let filterBtn = document.getElementById("filter"); // Get filter button once
    let showAll = false; // Renamed variable to reflect the new functionality
    let initialZoom;
    let debounceTimer;
    const debounceDelay = 250; // milliseconds

    function clearMarkers() {
        allMarkers.forEach(markerData => {
            map.removeLayer(markerData.marker);
            if (markerData.label) {
                map.removeLayer(markerData.label);
            }
        });
        allMarkers = [];
    }

    async function loadProjectsCSV() {
        const res = await fetch("projectrefined.csv");
        const text = await res.text();
        const rows = text.trim().split('\n').slice(1);

        return rows.map(row => {
            const parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (parts.length < 8) return null;

            const projectNumber = parts[0].trim().replace(/"/g, '');
            const name = parts[1].trim().replace(/"/g, '');
            const address = parts[2].trim().replace(/"/g, '');
            const lat = parseFloat(parts[3]);
            const lon = parseFloat(parts[4]);
            const legal = parts[5].trim().replace(/"/g, '') || '';
            const manager = parts[6].trim().replace(/"/g, '') || '';
            const status = parts[7].trim().replace(/"/g, '').toLowerCase() || '';

            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) return null;

            return { projectNumber, name, address, lat, lon, legal, manager, status };
        }).filter(p => p !== null);
    }

    function haversine(lat1, lon1, lat2, lon2) {
        const toRad = x => x * Math.PI / 180;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function renderProjectList(projects, userLat, userLon) {
        projectListDiv.innerHTML = "";
        clearMarkers();

        projects.forEach(p => {
            const distance = haversine(userLat, userLon, p.lat, p.lon);
            const popupHtml = `
                <strong>${p.projectNumber}</strong> ${p.name}<br>
                ${p.address}<br>
                ${p.legal}<br>
                Project Manager: ${p.manager}<br>
                Status: ${p.status}<br>
                <a href="https://www.google.com/maps/dir/?api=1&destination=$${p.lat},${p.lon}" target="_blank">Get Directions</a>
            `;

            const marker = L.marker([p.lat, p.lon], {
                icon: L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
                    iconSize: [15, 24],
                    iconAnchor: [7.5, 24],
                    popupAnchor: [0, -24]
                })
            }).addTo(map).bindPopup(popupHtml);

            const label = L.divIcon({
                className: 'leaflet-label',
                html: `<div style="font-size: 10px; white-space: nowrap;">${p.projectNumber}</div>`,
                iconSize: [null, null],
                iconAnchor: [marker.options.icon.options.iconSize[0] / 2, -marker.options.icon.options.iconSize[1] / 2]
            });
            const labelMarker = L.marker([p.lat, p.lon], { icon: label, interactive: false }).addTo(map);

            allMarkers.push({ marker, label: labelMarker, data: p });

            const div = document.createElement("div");
            div.className = "location";
            div.innerHTML = `<strong>${p.projectNumber}</strong> (${distance.toFixed(2)} km) ${p.name}`;
            div.onclick = () => {
                map.setView([p.lat, p.lon], 17);
                marker.openPopup();
            };
            projectListDiv.appendChild(div);
        });
    }

    async function initApp(userLat, userLon) {
        map = L.map('map').setView([userLat, userLon], 13);
        initialZoom = map.getZoom();

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        L.marker([userLat, userLon], {
            icon: L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-red.png',
                iconSize: [20, 32],
                iconAnchor: [10, 32],
                popupAnchor: [0, -32]
            })
        }).addTo(map).bindPopup("You are here").openPopup();

        allProjects = await loadProjectsCSV();
        allProjects.forEach(p => {
            p.distance = haversine(userLat, userLon, p.lat, p.lon);
        });
        allProjects.sort((a, b) => a.distance - b.distance);

        function applyFilter() {
            let filteredProjects = [...allProjects]; // Create a copy

            if (!showAll) {
                filteredProjects = filteredProjects.filter(p => ['active', 'proposal'].includes(p.status));
            }

            const term = searchInput.value.toLowerCase();
            if (term) {
                filteredProjects = filteredProjects.filter(p =>
                    p.projectNumber.toLowerCase().includes(term) ||
                    p.name.toLowerCase().includes(term) ||
                    p.address.toLowerCase().includes(term)
                );
            }

            renderProjectList(filteredProjects, userLat, userLon);
        }

        searchInput.addEventListener("input", function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(applyFilter, debounceDelay);
        });

        filterBtn.addEventListener("click", () => {
            showAll = !showAll;
            filterBtn.textContent = showAll ? "Show Active/Proposal Jobs" : "Show All Projects"; // Updated button text
            applyFilter();
        });

        applyFilter(); // Initial render with only active/proposal
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => initApp(pos.coords.latitude, pos.coords.longitude),
            err => {
                projectListDiv.innerText = "Location error: " + err.message;
            }
        );
    } else {
        projectListDiv.innerText = "Geolocation not supported.";
    }

    map.on('zoomend', function() {
        const currentZoom = map.getZoom();
        allMarkers.forEach(markerData => {
            if (markerData.label) {
                // Check if the label is currently on the map before trying to remove it
                if (currentZoom <= initialZoom - 2 && map.hasLayer(markerData.label)) {
                    map.removeLayer(markerData.label);
                } else if (currentZoom > initialZoom - 2 && !map.hasLayer(markerData.label)) {
                    map.addLayer(markerData.label);
                }
            }
        });
    });
</script>
