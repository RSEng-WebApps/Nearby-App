<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nearby Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial; height: 100vh; display: flex; flex-direction: column; }
    #container { flex: 1; display: flex; flex-direction: row; height: 100%; }
    #map { flex: 1; }
    #sidebar {
      width: 30vw; max-width: 400px; padding: 1em;
      background: rgba(255,255,255,0.75); box-sizing: border-box;
      display: flex; flex-direction: column;
    }
    #search, #filter {
      padding: 0.5em; font-size: 1em; margin-bottom: 0.5em;
    }
    #list { flex: 1; overflow-y: auto; font-size: 0.9em; }
    .location { padding: 0.4em 0; border-bottom: 1px solid #ccc; cursor: pointer; }
    .location:hover { background: #f0f0f0; }
    .leaflet-tooltip { font-size: 10px; background: none; border: none; box-shadow: none; }
    @media (orientation: portrait) {
      #container { flex-direction: column; }
      #sidebar { width: 100%; height: 40vh; max-width: none; }
      #map { height: 60vh; }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="map"></div>
    <div id="sidebar">
      <input type="text" id="search" placeholder="Search projects by number or name">
      <button id="filter">Show All Projects</button>
      <div id="list">Loading...</div>
    </div>
  </div>

  <script src="leaflet.js"></script>
  <script>
    let map, initialZoom, userMarker;
    let allProjects = [], markers = [], tooltips = [];
    let showAll = false;

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function loadCSV() {
      const res = await fetch('projectrefined.csv');
      const lines = (await res.text()).trim().split('\n').slice(1);
      return lines.map(line => {
        const [projectNumber, name, address, lat, lon, legal, manager, status] = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/"/g, '').trim());
        if (!lat || !lon || lat == 0 || lon == 0) return null;
        return { projectNumber, name, address, lat: +lat, lon: +lon, legal, manager, status: status.toLowerCase() };
      }).filter(p => p);
    }

    function renderProjects(projects, userLat, userLon) {
      const list = document.getElementById("list");
      list.innerHTML = "";
      markers.forEach(m => map.removeLayer(m));
      tooltips.forEach(t => map.removeLayer(t));
      markers = []; tooltips = [];

      projects.forEach(p => {
        const dist = haversine(userLat, userLon, p.lat, p.lon);
        const marker = L.marker([p.lat, p.lon]).addTo(map).bindPopup(
          `<strong>${p.projectNumber}</strong> ${p.name}<br>${p.legal}<br>${p.address}<br>
          Project Manager: ${p.manager}<br>Status: ${p.status}<br>
          <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}">Get Directions</a>`
        );
        const label = L.tooltip({
          permanent: true, direction: 'top', offset: [0, -20], className: 'leaflet-tooltip'
        }).setContent(p.projectNumber).setLatLng([p.lat, p.lon]).addTo(map);

        markers.push(marker);
        tooltips.push(label);

        const div = document.createElement("div");
        div.className = "location";
        div.innerHTML = `${dist.toFixed(2)}km <strong>${p.projectNumber}</strong> ${p.name}`;
        div.onclick = () => {
          map.setView([p.lat, p.lon], 17);
          marker.openPopup();
        };
        list.appendChild(div);
      });
    }

    function filterProjects(projects) {
      const term = document.getElementById("search").value.toLowerCase();
      return projects.filter(p =>
        (showAll || ['active', 'proposal'].includes(p.status)) &&
        (p.projectNumber.toLowerCase().includes(term) || p.name.toLowerCase().includes(term))
      );
    }

    async function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 13);
      initialZoom = map.getZoom();
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      userMarker = L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-red.png',
          iconSize: [20, 32],
          iconAnchor: [10, 32]
        })
      }).addTo(map).bindPopup("You are here").openPopup();

      allProjects = await loadCSV();
      allProjects.forEach(p => p.distance = haversine(lat, lon, p.lat, p.lon));
      allProjects.sort((a, b) => a.distance - b.distance);
      renderProjects(filterProjects(allProjects), lat, lon);

      document.getElementById("search").addEventListener("input", () =>
        renderProjects(filterProjects(allProjects), lat, lon)
      );
      document.getElementById("filter").addEventListener("click", () => {
        showAll = !showAll;
        document.getElementById("filter").textContent = showAll ? "Show Active/Proposal Only" : "Show All Projects";
        renderProjects(filterProjects(allProjects), lat, lon);
      });

      map.on("zoomend", () => {
        const z = map.getZoom();
        tooltips.forEach(t => {
          if (z > initialZoom - 2) {
            if (!map.hasLayer(t)) map.addLayer(t);
          } else {
            if (map.hasLayer(t)) map.removeLayer(t);
          }
        });
      });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => initMap(pos.coords.latitude, pos.coords.longitude),
        err => document.getElementById("list").innerText = "Location error: " + err.message
      );
    } else {
      document.getElementById("list").innerText = "Geolocation not supported.";
    }
  </script>
</body>
</html>
